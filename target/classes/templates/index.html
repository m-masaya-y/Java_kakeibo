<!doctype html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>収支管理</title>
  <style>
    body { font-family: sans-serif; display: flex; justify-content: center; padding: 20px; background: #f5f5f5; }
    .container { width: 100%; max-width: 900px; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
    form { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
    input, select { padding: 10px; border-radius: 6px; border: 1px solid #ccc; width: 180px; }
    button { padding: 10px 20px; border: none; background: #007bff; color: white; border-radius: 6px; cursor: pointer; }
    button:hover { opacity: 0.9; }
    .table-container { overflow-x: auto; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #87cefa; }
    .summary { margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 8px; }
    @media (max-width: 600px) { input, select { width: 100%; } }
  </style>
</head>
<body>
  <div class="container">
    <h2>収支管理アプリ</h2>

    <a href="https://minahada.com/wordpress/" target="_blank">
      <button style="margin-bottom:20px; background:#444;">トップに戻る</button>
    </a>

    <form id="entryForm">
      <select id="month" name="month">
        <option th:each="m : ${#numbers.sequence(1,12)}" th:value="${m}" th:text="${m + '月'}"></option>
      </select>

      <select id="type" name="type">
        <option value="income">収入</option>
        <option value="expense">支出</option>
      </select>

      <input type="number" id="amount" name="amount" placeholder="金額" required />

      <button type="submit">保存</button>
    </form>

    <div class="summary" id="summary">
      <span th:if="${#lists.isEmpty(dataList)}">まだデータがありません</span>
      <div th:unless="${#lists.isEmpty(dataList)}">
        <span th:each="monthStat : ${#aggregates.groupBy(dataList,'month')}" th:text="${monthStat.key + '月： 収入 ' + monthStat.stream().mapToInt(d -> d.income).sum() + ' 円 / 支出 ' + monthStat.stream().mapToInt(d -> d.expense).sum() + ' 円 → 残額 ' + (monthStat.stream().mapToInt(d -> d.income).sum() - monthStat.stream().mapToInt(d -> d.expense).sum()) + ' 円'}"></span><br/>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>月</th>
            <th>収入</th>
            <th>支出</th>
            <th>削除</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="item : ${dataList}">
            <td th:text="${item.month + '月'}"></td>
            <td th:text="${item.income}"></td>
            <td th:text="${item.expense}"></td>
            <td>
              <form th:action="@{/delete}" method="post">
                <input type="hidden" th:name="id" th:value="${item.id}" />
                <button type="submit" style="background:#d9534f;">削除</button>
              </form>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const form = document.getElementById('entryForm');
    form.addEventListener('submit', e => {
      e.preventDefault();
      const month = document.getElementById('month').value;
      const type = document.getElementById('type').value;
      const amount = Number(document.getElementById('amount').value);

      fetch('/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `month=${month}&type=${type}&amount=${amount}`
      }).then(() => location.reload());
    });
  </script>
</body>
</html>
